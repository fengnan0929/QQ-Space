<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>主页-闲言</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="res/layui/css/layui.css">
    <link rel="stylesheet" href="res/static/css/mian.css">

</head>
<body class="lay-blog">
<div class="header">
    <div class="header-wrap">
        <h1 class="logo pull-left">
            <a href="index.html">
                <img src="res/static/images/logo.png" alt="" class="logo-img">
                <img src="res/static/images/logo-text.png" alt="" class="logo-text">
            </a>
        </h1>
        <form class="layui-form blog-seach pull-left" action="">
            <div class="layui-form-item blog-sewrap">
                <div class="layui-input-block blog-sebox">
                    <i class="layui-icon layui-icon-search"></i>
                    <input type="text" name="title" lay-verify="title" autocomplete="off" class="layui-input">
                </div>
            </div>
        </form>
        <div class="blog-nav pull-right">
            <ul class="layui-nav pull-left">
                <li class="layui-nav-item layui-this"><a href="index.html">首页</a></li>
                <li class="layui-nav-item"><a href="message.html">留言</a></li>
                <li class="layui-nav-item"><a href="about.html">关于</a></li>
            </ul>
            <a href="#" class="personal pull-left  layui-nav-item exit" style="font-size: 16px;">
                <i class="layui-icon layui-icon-username"></i>
                退出
            </a>
        </div>
        <div class="mobile-nav pull-right" id="mobile-nav">
            <a href="javascript:;">
                <i class="layui-icon layui-icon-more"></i>
            </a>
        </div>
    </div>
    <ul class="pop-nav" id="pop-nav">
        <li><a href="index.html">首页</a></li>
        <li><a href="message.html">留言</a></li>
        <li><a href="about.html">关于</a></li>
    </ul>
</div>
<div class="bg">
    <div class="bg-wrap">
        <div class="self-intro">
            <span class="head-pic"></span>
            <span class="nick">春风吻我像蛋挞</span>
        </div>
    </div>
</div>
<div class="container-wrap indexTop">
    <!--屏幕正中动态列表-->
    <div class="index-container container">
        <div class="leftBar">
            <div class="data-statics">
                <div class="static-item">
                    <span>249</span>
                    <div>动态</div>
                </div>
                <div class="static-item">
                    <span>125</span>
                    <div>留言</div>
                </div>
            </div>
            <div class="personal-intro">
                <span class="intro-head">个人档</span>
                <span class="intro-item"><i class="layui-icon layui-icon-component"></i>我是哐哐哐，今年三岁了</span>
                <span class="intro-item"><i class="layui-icon layui-icon-nan"></i>女 23岁 天蝎座</span>
            </div>
            <div class="friendList">
                <span class="intro-head">我的好友</span>
                <ul class="friend-items">
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                    <li>
                        <span class="item-head"></span>
                        <span>张三</span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="contar-wrap index-wrap">
            <div class="contar-wrap fixed">
                <form class="layui-form" action="">
                    <div class="layui-form-item layui-form-text">
                        <textarea class="layui-textarea" id="LAY-msg-content"></textarea>
                    </div>
                </form>
                <div class="item-list">
                    <span class="suc-upload " id="suc_upload"></span>
                    <span class="image-path " id="imagepath"></span>
                    <button class="btn" id="submit-btn">发布动态</button>
                    <span class="fileUpload">
                        <input type="file" id="upload" accept="image/jpg, image/png, image/jpeg, image/gif">
                        <button class="upload btn">上传图片</button>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer">
    <p>
        <span>&copy; 2019</span>
        <span><a href="http://www.layui.com" target="_blank">浙江大学软件学院</a></span>
        <span>S403</span>
    </p>
    <p><span>人生就是一场修行，祝君猪事顺利</span></p>
</div>

<script src="res/jquery/Myfunc.js"></script>
<!--新动态模版-->
<script id="LAY-msg-tpl" type="text/html">
    <div class="item">
        <div class="item-box  layer-photos-demo1 layer-photos-demo">
            <div class="publish-details">
                <span class="head-nail"  {{d.avatar}}></span>
                <div class="nail-right">
                    <span class="nickname">{{d.username}}</span>
                    <span class="publish-time">发布于：{{d.time}}</span>
                </div>
            </div>
            <p>{{d.content}}</p>
            <img {{d.pic}} alt="" {{d.style}}>
        </div>
        <div class="comment count">
            <a href="details.html#comment">评论</a>
            <a href="javascript:;" class="like">点赞</a>
        </div>
    </div>
</script>
<script src="res/layui/layui.js"></script>
<script>
    layui.config({
        base: 'res/static/js/'
    }).use('blog');
</script>
<script src="res/jquery/jquery-1.12.4.js"></script>
<script>
    $(function () {
        // 获取当前用户的个人信息以及好友动态
        let userAccount = JSON.parse(localStorage.getItem('UserAccount'));
        $.ajax({
            url:'http://192.168.1.105:8080/look/homepage',
            type:'post',
            contentType:'application/json',
            xhrFields:{
                withCredentials:true
            },
            data:JSON.stringify({'owner':userAccount}),
            success:function (data) {
                console.log(data);
                // 初始化用户信息
                $('.head-pic').css({
                    background:`url("${data.personal.headpic}") center center`,
                    backgroundSize: "100%"
                });
                $('.nick').text(data.personal.nickname);
                $('.intro-item').eq(0).html('<i class="layui-icon layui-icon-component"></i>&nbsp;' + data.personal.motto);
                $('.intro-item').eq(1).html('<i class="layui-icon layui-icon-nan"></i>&nbsp;' + data.personal.sex + " " + data.personal.age + '岁 ' + data.personal.xinzuo);

                // 初始化首页统计信息
                $('.static-item').eq(0).children('span').text(data.statics.dongtai);
                $('.static-item').eq(1).children('span').text(data.statics.liuyan);

                // 初始化好友列表
                let content = '';
                for (let i = 0; i < data.friends.length; i++) {
                    content = content + `<li >
                                        <span class="item-head" style="background:url('${data.friends[i].headpic}') center center;background-size: 100%"></span>
                                        <span>${data.friends[i].nickname}</span>
                                        <span class="friendEmail" style="display: none" >${data.friends[i].email}</span>
                                  </li>`
                }
                $('.friend-items').html(content);
                //展示好友动态
                $(showMoment(data.dongtailist)).insertAfter(".fixed");
            }
        });

        $('.friend-items').delegate('li','click',function () {
            let friend = $(this).children('.friendEmail').text();
            console.log(friend);
            /*localStorage.setItem("UserAccount", JSON.stringify(friend));
            var newWeb=window.open('_blank');
            newWeb.location='index.html';*/
        });

        // 退出跳转
        $('.exit').on("click", function () {
            if (confirm("您确认要退出闲言吗？") == true) {
                $(window).attr('location', 'login.html');
                // 清除当前用户的cookies和账户
                localStorage.removeItem('UserAccount');
            }
        });

        // 动态列表懒加载
        let flag = true;  //是否在加载过程中
        $(window).on('scroll', function () {
            if ($(window).height() + $(window).scrollTop() + 80 >= $(document).height() && flag) {
                // 提示加载中
                $(".index-wrap").append('<div class="item-btn loading" ><span>加载中... </span><span class="loading-pic"></span></div>');
                flag = false; //加载中不允许插入加载提示
                // 获取下一页动态
                $.ajax({
                    url:'',
                    data:'', // 参数是页码
                    type:'post',
                    contentType:'application/json',
                    success:function (data) {
                        if(data.isMore){
                            $(".index-wrap").append(showMoment(data.list)); // 在动态列表内插入新的动态
                            $('.item-btn').remove();   // 移除加载提示
                            flag = true;
                        }
                        else{
                            // 显示已经是全部
                            $('.item-btn').remove();   // 移除加载提示
                        }
                    },
                });
            }
        });
    });
</script>
</body>
</html>